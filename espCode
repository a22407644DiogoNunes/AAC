#include <ESP8266WiFi.h>
#include <ESP8266HTTPClient.h>
#include <Servo.h>

// -------- WIFI --------
const char* WIFI_SSID = "NOS-E386";
const char* WIFI_PASS = "EK397RUY";

// -------- SERVER --------
const char* SERVER_URL =
"https://refactored-space-enigma-pj9gj4xq6xvjcq4q-5000.app.github.dev/receive";

// -------- PINOS --------
#define TRIG_PIN 2      // D4
#define ECHO_PIN 14     // D5
#define SERVO_H_PIN 12  // D6
#define SERVO_V_PIN 0   // D3 ⚠️ cuidado boot

// -------- RADAR --------
#define ROWS 5
#define COLS 41

#define H_MIN 30
#define H_MAX 150
#define H_STEP 3

#define DIST_THRESHOLD_CM 30.0
#define NUM_READINGS 3

const int vStart = 40;
const int vStep  = 10;

// -----------------------
Servo servoH;
Servo servoV;

char radar[ROWS][COLS];

// -------- FUNÇÕES --------
void clearRadar() {
  for (int r = 0; r < ROWS; r++)
    for (int c = 0; c < COLS; c++)
      radar[r][c] = '.';
}

float measureDistanceCM() {
  float total = 0;
  int valid = 0;

  for (int i = 0; i < NUM_READINGS; i++) {
    digitalWrite(TRIG_PIN, LOW);
    delayMicroseconds(2);
    digitalWrite(TRIG_PIN, HIGH);
    delayMicroseconds(10);
    digitalWrite(TRIG_PIN, LOW);

    long duration = pulseIn(ECHO_PIN, HIGH, 30000);
    if (duration > 0) {
      float d = (duration * 0.0343) / 2.0;
      if (d >= 2 && d <= 400) {
        total += d;
        valid++;
      }
    }
    delay(5);
  }

  if (valid == 0) return -1;
  return total / valid;
}

void sendHTTP(String payload) {
  if (WiFi.status() != WL_CONNECTED) return;

  WiFiClientSecure client;
  client.setInsecure();

  HTTPClient http;
  http.begin(client, SERVER_URL);
  http.addHeader("Content-Type", "application/json");

  String body = "{\"pattern\":\"" + payload + "\"}";
  http.POST(body);

  http.end();
}

// -------- SETUP --------
void setup() {
  Serial.begin(115200);

  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);

  servoH.attach(SERVO_H_PIN);
  servoV.attach(SERVO_V_PIN);

  servoH.write(H_MIN);
  servoV.write(vStart);

  clearRadar();

  WiFi.begin(WIFI_SSID, WIFI_PASS);
  while (WiFi.status() != WL_CONNECTED) delay(500);
}

// -------- LOOP --------
void loop() {

  clearRadar();

  for (int row = 0; row < ROWS; row++) {

    int vAngle = vStart + row * vStep;
    servoV.write(vAngle);
    delay(150);

    for (int hAngle = H_MIN; hAngle <= H_MAX; hAngle += H_STEP) {

      servoH.write(hAngle);
      delay(40);

      float dist = measureDistanceCM();
      bool detected = (dist > 0 && dist <= DIST_THRESHOLD_CM);

      int col = map(hAngle, H_MIN, H_MAX, 0, COLS - 1);
      col = constrain(col, 0, COLS - 1);

      radar[row][col] = detected ? 'X' : '.';
    }

    servoH.write(H_MIN);
    delay(120);
  }

  // ----- Constrói payload -----
  String payload = "";

  for (int r = 0; r < ROWS; r++) {
    for (int c = 0; c < COLS; c++) {
      payload += radar[r][c];
    }
    if (r < ROWS - 1) payload += "\\n";
  }

  sendHTTP(payload);

  delay(600);
}