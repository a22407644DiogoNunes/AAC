#include <ESP8266WiFi.h>
#include <ESP8266HTTPClient.h>
#include <Servo.h>

// -------- CONFIG --------
const char* WIFI_SSID = "freeulusofona";
const char* WIFI_PASS = "";

const char* SERVER_URL =
"https://refactored-space-enigma-pj9gj4xq6xvjcq4q-5000.app.github.dev/receive";

// Pinos
#define TRIG_PIN 2      // D4
#define ECHO_PIN 14     // D5
#define SERVO_H_PIN 12  // D6 ‚Üí horizontal
#define SERVO_V_PIN 0   // D3 ‚Üí vertical ‚ö†Ô∏è

// Par√¢metros
#define DIST_THRESHOLD_CM 15.0
#define INTERVAL_MS 200
#define BUFFER_LEN 40
#define NUM_READINGS 5
#define ROWS 5 
#define H_STEP 2       // passo horizontal
#define H_MIN 60
#define H_MAX 120

// Vertical
const int vStart = 0;   
const int vStep  = 10;    

// ------------------------
String rowsBuffer[ROWS];

Servo servoH;
Servo servoV;

String buffer = "";
int currentRow = 0;

// Horizontal
int hAngle = 90;
int hDir = 1;

// ---------- HC-SR04 ----------
float measureDistanceCM() {
  float total = 0;
  int valid = 0;

  for (int i = 0; i < NUM_READINGS; i++) {
    digitalWrite(TRIG_PIN, LOW);
    delayMicroseconds(2);
    digitalWrite(TRIG_PIN, HIGH);
    delayMicroseconds(10);
    digitalWrite(TRIG_PIN, LOW);

    long duration = pulseIn(ECHO_PIN, HIGH, 30000);
    if (duration > 0) {
      float d = (duration * 0.0343) / 2.0;
      if (d >= 2 && d <= 400) {
        total += d;
        valid++;
      }
    }
    delay(10);
  }

  if (valid == 0) return -1;
  return total / valid;
}

// ---------- HTTP ----------
void sendHTTP(const String& payload) {
  if (WiFi.status() != WL_CONNECTED) return;

  WiFiClientSecure client;
  client.setInsecure();

  HTTPClient http;
  http.begin(client, SERVER_URL);
  http.addHeader("Content-Type", "application/json");

  String body = "{\"pattern\":\"" + payload + "\"}";

  int code = http.POST(body);
  Serial.print("HTTP code: ");
  Serial.println(code);

  http.end();
}

// ---------- SETUP ----------
void setup() {
  Serial.begin(115200);
  delay(2000);

  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);

  servoH.attach(SERVO_H_PIN);
  servoV.attach(SERVO_V_PIN);

  // inicializa servos
  servoH.write(hAngle);
  servoV.write(vStart); 

  Serial.print("Ligando ao WiFi");
  WiFi.begin(WIFI_SSID, WIFI_PASS);

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("\nWiFi ligado!");
  Serial.println(WiFi.localIP());
}

// ---------- LOOP ----------
void loop() {
  unsigned long start = millis();

  // Movimento horizontal
  hAngle += hDir * H_STEP;

  if (hAngle >= H_MAX) {
    hAngle = H_MAX;
    hDir = -1;
  }

  if (hAngle <= H_MIN) {
    hAngle = H_MIN;
    hDir = 1;

    // üî• FIM DO SWEEP ‚Üí salva linha
    if (buffer.length() > 0) {
      rowsBuffer[currentRow] = buffer;
      buffer = "";
    }

    // Pr√≥xima linha vertical
    currentRow++;

    if (currentRow >= ROWS) {
      // üî• J√° fez as 5 varreduras ‚Üí envia tudo
      String fullPattern = "";

      for (int i = 0; i < ROWS; i++) {
        fullPattern += rowsBuffer[i];
        if (i < ROWS - 1) fullPattern += "\\n";
      }

      sendHTTP(fullPattern);

      // Reset
      for (int i = 0; i < ROWS; i++) rowsBuffer[i] = "";
      currentRow = 0;
    }

    // Atualiza servo vertical
    int vAngle = vStart + currentRow * vStep;
    servoV.write(vAngle);
    delay(100);
  }

  servoH.write(hAngle);
  delay(40);

  float dist = measureDistanceCM();
  bool detected = (dist > 0 && dist <= DIST_THRESHOLD_CM);

  buffer += detected ? "X" : ".";

  unsigned long elapsed = millis() - start;
  if (elapsed < INTERVAL_MS) delay(INTERVAL_MS - elapsed);
}